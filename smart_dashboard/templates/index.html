<!DOCTYPE html>
<html>
<head>
<title>Live Sensor Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
    background:#0f172a;
    color:white;
    font-family:Arial;
    padding:20px;
}
.cards{
    display:flex;
    gap:15px;
    margin-bottom:20px;
}
.card{
    flex:1;
    background:#1e293b;
    padding:15px;
    border-radius:10px;
    text-align:center;
}
.value{
    font-size:26px;
    font-weight:bold;
}
.alert{ color:red; font-weight:bold; }

.charts-row{
    display:flex;
    gap:15px;
    margin-bottom:30px;
}
.chart-box{
    background:#1e293b;
    padding:12px;
    border-radius:10px;
    width:33%;
    cursor:pointer;
}
canvas{ height:160px !important; }

/* TABLE */
table{
    width:100%;
    border-collapse:collapse;
    background:#020617;
    border-radius:10px;
    overflow:hidden;
}
th,td{
    padding:10px;
    text-align:center;
    border-bottom:1px solid #334155;
}
th{ background:#1e293b; }
tr:hover{ background:#1e293b; }

/* ZOOM */
.modal{
    display:none;
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.85);
    justify-content:center;
    align-items:center;
    z-index:999;
}
.modal-content{
    background:#020617;
    padding:20px;
    width:90%;
    height:80%;
    border-radius:12px;
}
.modal canvas{ height:100% !important; }
.close{
    float:right;
    font-size:22px;
    cursor:pointer;
}
</style>
</head>

<body>

<h2>üåç Environment Monitoring Dashboard</h2>
<p>Live Time: <span id="clock"></span></p>


<div class="cards">
    <div class="card">üå° Temperature
        <div class="value" id="temp">--</div>
        <div id="tempAlert"></div>
    </div>
    <div class="card">üíß Humidity
        <div class="value" id="hum">--</div>
        <div id="humAlert"></div>
    </div>
    <div class="card">üß™ Gas
        <div class="value" id="gas">--</div>
        <div id="gasAlert"></div>
    </div>
</div>


<div class="charts-row">
    <div class="chart-box" onclick="openZoom('temp')">
        <h4>Temperature</h4>
        <canvas id="tempChart"></canvas>
    </div>
    <div class="chart-box" onclick="openZoom('hum')">
        <h4>Humidity</h4>
        <canvas id="humChart"></canvas>
    </div>
    <div class="chart-box" onclick="openZoom('gas')">
        <h4>Gas</h4>
        <canvas id="gasChart"></canvas>
    </div>
</div>


<h3>üìã Sensor Data Table</h3>
<table>
<thead>
<tr>
    <th>#</th>
    <th>Temperature (¬∞C)</th>
    <th>Humidity (%)</th>
    <th>Gas (PPM)</th>
    <th>Timestamp</th>
</tr>
</thead>
<tbody id="dataTable"></tbody>
</table>


<div class="modal" id="zoomModal">
    <div class="modal-content">
        <span class="close" onclick="closeZoom()">‚úñ</span>
        <canvas id="zoomChart"></canvas>
    </div>
</div>

<script>
const TEMP_LIMIT=40, HUM_LIMIT=80, GAS_LIMIT=500;
let zoomChart;

function updateClock(){
    clock.innerText=new Date().toLocaleTimeString();
}
setInterval(updateClock,1000);

function makeChart(ctx,color){
    return new Chart(ctx,{
        type:'line',
        data:{labels:[],datasets:[{data:[],borderColor:color,borderWidth:2}]},
        options:{responsive:true,maintainAspectRatio:false,animation:false}
    });
}

const tempChart=makeChart(tempChartCanvas=document.getElementById("tempChart"),"orange");
const humChart =makeChart(document.getElementById("humChart"),"deepskyblue");
const gasChart =makeChart(document.getElementById("gasChart"),"lime");

async function fetchData(){
    const res=await fetch("/data");
    const data=await res.json();
    if(!data.length) return;

    const last=data[data.length-1];

    temp.innerText=last[0]+" ¬∞C";
    hum.innerText =last[1]+" %";
    gas.innerText =last[2]+" PPM";

    tempAlert.innerHTML=last[0]>TEMP_LIMIT?"<span class='alert'>HIGH</span>":"";
    humAlert.innerHTML =last[1]>HUM_LIMIT?"<span class='alert'>HIGH</span>":"";
    gasAlert.innerHTML =last[2]>GAS_LIMIT?"<span class='alert'>DANGER</span>":"";

    const labels=data.map(d=>d[3]);
    tempChart.data.labels=labels;
    tempChart.data.datasets[0].data=data.map(d=>d[0]);
    tempChart.update();

    humChart.data.labels=labels;
    humChart.data.datasets[0].data=data.map(d=>d[1]);
    humChart.update();

    gasChart.data.labels=labels;
    gasChart.data.datasets[0].data=data.map(d=>d[2]);
    gasChart.update();

    
    dataTable.innerHTML="";
    data.forEach((d,i)=>{
        dataTable.innerHTML+=`
        <tr>
            <td>${i+1}</td>
            <td>${d[0]}</td>
            <td>${d[1]}</td>
            <td>${d[2]}</td>
            <td>${d[3]}</td>
        </tr>`;
    });
}
setInterval(fetchData,2000);
fetchData();

function openZoom(type){
    zoomModal.style.display="flex";
    const ctx=zoomChartCanvas=document.getElementById("zoomChart").getContext("2d");
    if(zoomChart) zoomChart.destroy();
    let src= type==="temp"?tempChart:type==="hum"?humChart:gasChart;
    zoomChart=new Chart(ctx,{type:'line',data:JSON.parse(JSON.stringify(src.data))});
}
function closeZoom(){ zoomModal.style.display="none"; }
</script>

</body>
</html>
